<%- include('../layouts/header') %>
<%- include('../layouts/sidebar') %>

<main
  class="bg-gray-50 min-h-screen px-3 sm:px-4 md:px-6 py-6
         w-full md:ml-64 transition-all duration-300"
>
  <div class="w-full max-w-4xl mx-auto">

    <!-- ================= MOBILE HEADER ================= -->
    <div class="flex items-center justify-between mb-6 md:hidden">
      <button
        id="menuBtn"
        class="bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600
               text-white px-3 py-2 rounded-lg shadow text-xl"
      >
        â˜°
      </button>

      <h1 class="text-lg font-bold text-gray-800">
        Edit Class
      </h1>

      <a
        href="/admin/classes"
        class="bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600
               text-white px-3 py-2 rounded-lg text-sm shadow"
      >
        Back
      </a>
    </div>

    <!-- ================= DESKTOP HEADER ================= -->
    <div class="hidden md:block mb-6">
      <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">
        Edit Class
      </h2>
      <p class="text-sm text-gray-500 mt-1">
        Update the details of your class
      </p>
    </div>

    <!-- ================= FORM CARD ================= -->
    <div class="bg-white rounded-2xl shadow border p-5 sm:p-8">
      <form
        method="POST"
        action="/admin/classes/edit/<%= classdata._id %>"
        class="space-y-5"
      >

        <!-- COURSE -->
        <div>
          <label class="block text-sm font-semibold mb-1">Course</label>
          <select
            name="courseId"
            required
            class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
          >
            <% data.forEach(c => { %>
              <option
                value="<%= c._id %>"
                <%= c._id.toString() === classdata.courseId._id.toString()
                  ? 'selected' : '' %>
              >
                <%= c.title %>
              </option>
            <% }) %>
          </select>
        </div>

        <!-- TITLE -->
        <div>
          <label class="block text-sm font-semibold mb-1">Class Title</label>
          <input
            name="title"
            value="<%= classdata.title %>"
            required
            class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <!-- DESCRIPTION -->
        <div>
          <label class="block text-sm font-semibold mb-1">Description</label>
          <textarea
            name="description"
            rows="3"
            class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
          ><%= classdata.description %></textarea>
        </div>

        <!-- MEETING LINK -->
        <div>
          <label class="block text-sm font-semibold mb-1">Meeting Link</label>
          <input
            name="meetingLink"
            value="<%= classdata.meetingLink %>"
            class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <!-- DATES -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Start Date</label>
            <input
              type="date"
              name="startDate"
              value="<%= classdata.startDate.toISOString().slice(0,10) %>"
              required
              min="<%= new Date().toISOString().slice(0,10) %>"
              class="w-full border rounded-lg px-3 py-2"
            />
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">End Date</label>
            <input
              type="date"
              name="endDate"
              value="<%= classdata.endDate.toISOString().slice(0,10) %>"
              required
              min="<%= new Date().toISOString().slice(0,10) %>"
              class="w-full border rounded-lg px-3 py-2"
            />
          </div>
        </div>

        <!-- SCHEDULE -->
        <div>
          <label class="block text-sm font-semibold mb-2">Schedule</label>

          <div id="schedule-container">
          <% classdata.schedule.forEach((s, i) => { %>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-2">
              <select
                name="schedule[<%= i %>][day]"
                class="border rounded-lg px-3 py-2"
              >
                <% ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d => { %>
                  <option <%= d === s.day ? 'selected' : '' %>>
                    <%= d %>
                  </option>
                <% }) %>
              </select>

              <input
                type="time"
                name="schedule[<%= i %>][startTime]"
                value="<%= s.startTime %>"
                class="border rounded-lg px-3 py-2"
              />

              <div class="flex items-center gap-2">
                <input
                  type="time"
                  name="schedule[<%= i %>][endTime]"
                  value="<%= s.endTime %>"
                  class="border rounded-lg px-3 py-2 flex-1"
                />
                <button
                  type="button"
                  class="text-red-500 text-xs font-semibold remove-schedule"
                  title="Remove this schedule row"
                >
                  Remove
                </button>
              </div>
            </div>
          <% }) %>
          </div>

          <button
            type="button"
            id="add-schedule-edit"
            class="mt-3 text-blue-600 text-xs font-semibold"
          >
            + Add another schedule
          </button>
        </div>

        <!-- PRICE & MAX STUDENTS -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Price</label>
            <input
              type="number"
              name="price"
              value="<%= classdata.price %>"
              class="w-full border rounded-lg px-3 py-2"
            />
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">Max Students</label>
            <input
              type="number"
              name="maxStudents"
              value="<%= classdata.maxStudents %>"
              class="w-full border rounded-lg px-3 py-2"
            />
          </div>
        </div>

        <!-- STATUS -->
        <div>
          <label class="block text-sm font-semibold mb-1">Status</label>
          <select
            name="status"
            class="w-full border rounded-lg px-3 py-2"
          >
            <% ['UPCOMING','ONGOING','COMPLETED'].forEach(s => { %>
              <option <%= s === classdata.status ? 'selected' : '' %>>
                <%= s %>
              </option>
            <% }) %>
          </select>
        </div>

       <!-- INSTRUCTOR -->
<div>
  <label class="block text-sm font-semibold mb-1">Instructor</label>

  <select
    name="tutorId"
    required
    class="w-full border rounded-lg px-3 py-2 bg-white
           focus:ring-2 focus:ring-blue-500 focus:outline-none"
  >
    <% tutors.forEach(t => { %>
      <option
        value="<%= t._id %>"
        <%= t._id.toString() === classdata.tutorId._id.toString()
          ? "selected"
          : "" %>
      >
        <%= t.name %> (<%= t.email %>)
      </option>
    <% }) %>
  </select>
</div>


        <!-- SUBMIT -->
        <button
          type="submit"
          class="w-full sm:w-auto bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600
                 text-white px-6 py-3 rounded-xl font-bold shadow hover:opacity-90 transition"
        >
          Update Class
        </button>
      </form>
    </div>
  </div>
</main>

<script>
  const menuBtn = document.getElementById("menuBtn");
  const sidebar = document.querySelector(".sidebar");

  if (menuBtn && sidebar) {
    menuBtn.addEventListener("click", () => {
      sidebar.classList.toggle("hidden");
    });
  }

  // ================= FILTER SCHEDULE DAY OPTIONS BY DATE RANGE =================
  function getAllowedWeekdays() {
    const startInput = document.querySelector('input[name="startDate"]');
    const endInput = document.querySelector('input[name="endDate"]');

    if (!startInput || !endInput || !startInput.value || !endInput.value) {
      return null;
    }

    const start = new Date(startInput.value);
    const end = new Date(endInput.value);
    if (isNaN(start) || isNaN(end) || end < start) {
      return null;
    }

    const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    const allowed = new Set();
    const cursor = new Date(start);

    while (cursor <= end) {
      allowed.add(dayNames[cursor.getDay()]);
      cursor.setDate(cursor.getDate() + 1);
    }

    return allowed;
  }

  function filterScheduleDaysByDateRange() {
    const allowed = getAllowedWeekdays();
    const selects = document.querySelectorAll(
      'select[name^="schedule"][name$="[day]"]'
    );

    selects.forEach((sel) => {
      const options = sel.options;
      for (let i = 0; i < options.length; i++) {
        const opt = options[i];
        if (!allowed) {
          opt.disabled = false;
        } else {
          opt.disabled = !allowed.has(opt.textContent.trim());
        }
      }

      if (sel.selectedOptions.length && sel.selectedOptions[0].disabled) {
        for (let i = 0; i < options.length; i++) {
          if (!options[i].disabled) {
            sel.value = options[i].textContent.trim();
            break;
          }
        }
      }
    });
  }

  // When start/end date is today and same day, only allow remaining time today
  function applyTodayTimeMin() {
    const startInput = document.querySelector('input[name="startDate"]');
    const endInput = document.querySelector('input[name="endDate"]');
    if (!startInput || !endInput) return;

    const startVal = startInput.value;
    const endVal = endInput.value;
    const todayStr = new Date().toISOString().slice(0, 10);

    const isTodaySingleDay =
      startVal && endVal && startVal === endVal && startVal === todayStr;

    const timeInputs = document.querySelectorAll(
      '#schedule-container input[type="time"]'
    );

    if (isTodaySingleDay) {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      const minTime = `${hh}:${mm}`;

      timeInputs.forEach((input) => {
        input.min = minTime;
        if (input.value && input.value < minTime) {
          input.value = minTime;
        }
      });
    } else {
      timeInputs.forEach((input) => {
        input.min = "";
      });
    }
  }

  document.querySelector('input[name="startDate"]').addEventListener(
    "change",
    () => {
      filterScheduleDaysByDateRange();
      applyTodayTimeMin();
    }
  );
  document.querySelector('input[name="endDate"]').addEventListener(
    "change",
    () => {
      filterScheduleDaysByDateRange();
      applyTodayTimeMin();
    }
  );

  // Initial filter for edit page
  filterScheduleDaysByDateRange();
  applyTodayTimeMin();

  // ================= ADD NEW SCHEDULE ROW =================
  document.getElementById("add-schedule-edit")?.addEventListener("click", () => {
    const container = document.getElementById("schedule-container");
    if (!container) return;
    const index = container.children.length;

    container.insertAdjacentHTML("beforeend", `
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-2">
        <select name="schedule[${index}][day]" class="border rounded-lg px-3 py-2">
          <option>Mon</option><option>Tue</option><option>Wed</option>
          <option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
        </select>
        <input
          type="time"
          name="schedule[${index}][startTime]"
          class="border rounded-lg px-3 py-2"
        />
        <div class="flex items-center gap-2">
          <input
            type="time"
            name="schedule[${index}][endTime]"
            class="border rounded-lg px-3 py-2 flex-1"
          />
          <button
            type="button"
            class="text-red-500 text-xs font-semibold remove-schedule"
            title="Remove this schedule row"
          >
            Remove
          </button>
        </div>
      </div>
    `);

    filterScheduleDaysByDateRange();
    applyTodayTimeMin();
  });

  // ================= REMOVE SCHEDULE ROWS (MARK AS DISABLED) =================
  document.addEventListener("click", (e) => {
    if (e.target.classList.contains("remove-schedule")) {
      const row = e.target.closest(
        "div.grid.grid-cols-1.sm\\:grid-cols-3.gap-3.mb-2"
      );
      if (!row) return;

      // Physically remove the row so its fields are not submitted at all
      row.remove();
    }
  });

  // ================= VALIDATE SCHEDULE ROWS ON SUBMIT =================
  const editClassForm = document.querySelector('form[action^="/admin/classes/edit/"]');
  if (editClassForm) {
    editClassForm.addEventListener("submit", (e) => {
      const rows = document.querySelectorAll(
        "div.grid.grid-cols-1.sm\\:grid-cols-3.gap-3.mb-2"
      );

      let validCount = 0;
      let error = null;

      rows.forEach((row) => {
        const startInput = row.querySelector('input[name*="[startTime]"]');
        const endInput = row.querySelector('input[name*="[endTime]"]');
        if (!startInput || !endInput) return;

        const startVal = (startInput.value || "").trim();
        const endVal = (endInput.value || "").trim();

        if (!startVal && !endVal) {
          error =
            "Each schedule row must have both start and end time filled. Remove empty rows or complete them.";
        } else if (!startVal || !endVal) {
          error =
            "Each schedule row must have both start and end time filled.";
        } else {
          validCount += 1;
        }
      });

      if (!error && validCount === 0) {
        error = "Please add at least one schedule with start and end time.";
      }

      if (error) {
        e.preventDefault();
        alert(error);
      }
    });
  }
</script>

<%- include('../layouts/footer') %>

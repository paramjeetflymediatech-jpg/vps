<%- include('../layouts/header') %>
<%- include('../layouts/sidebar') %>

<main
  class="bg-gray-50 min-h-screen px-3 sm:px-4 md:px-6 py-6
         w-full md:pl-64 transition-all overflow-x-hidden"
>
  <div class="max-w-4xl mx-auto w-full">

    <!-- MOBILE HEADER -->
    <div class="flex items-center justify-between mb-6 md:hidden">
      <button id="menuBtn"
        class="bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600
               text-white px-3 py-2 rounded-lg shadow text-xl">
        â˜°
      </button>
      <h1 class="text-lg font-bold text-gray-800">Create Class</h1>
      <a href="/admin/classes"
         class="bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600
                text-white px-3 py-2 rounded-lg text-sm shadow">
        Back
      </a>
    </div>

    <!-- DESKTOP HEADER -->
    <div class="hidden md:block mb-6">
      <h2 class="text-3xl font-bold text-gray-800">Create Class</h2>
      <p class="text-sm text-gray-500">Fill in the details to publish a new class</p>
    </div>

    <!-- FORM CARD -->
    <div class="bg-white rounded-2xl shadow border p-4 sm:p-6 md:p-8">
      <form method="POST" action="/admin/classes/create" class="space-y-6">

        <!-- TITLE -->
        <div>
          <label class="block text-sm font-semibold mb-1">Class Title</label>
          <input name="title" required
            class="w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500"/>
        </div>

        <!-- DESCRIPTION -->
        <div>
          <label class="block text-sm font-semibold mb-1">Description</label>
          <textarea name="description" rows="3"
            class="w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500"></textarea>
        </div>

        <!-- COURSE -->
        <div>
          <label class="block text-sm font-semibold mb-1">Course</label>
          <select name="courseId" required
            class="w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500">
            <option value="">Select Course</option>
            <% data.forEach(c => { %>
              <option value="<%= c._id %>"><%= c.title %></option>
            <% }) %>
          </select>
        </div>

        <!-- INSTRUCTOR -->
        <div>
          <label class="block text-sm font-semibold mb-1">Instructor</label>
          <select name="tutorId" required
            class="w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500">
            <option value="">Select Instructor</option>
            <% tutors.forEach(i => { %>
              <option value="<%= i._id %>"><%= i.name %></option>
            <% }) %>
          </select>
        </div>

        <!-- PRICE + MAX -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Price</label>
            <input type="number" name="price" required
              class="w-full border rounded-xl px-4 py-3"/>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">Max Students</label>
            <input type="number" name="maxStudents"
              class="w-full border rounded-xl px-4 py-3"/>
          </div>
        </div>

        <!-- DATES -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Start Date</label>
            <input
              type="date"
              name="startDate"
              required
              min="<%= new Date().toISOString().slice(0,10) %>"
              class="w-full border rounded-xl px-4 py-3"
            />
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">End Date</label>
            <input
              type="date"
              name="endDate"
              required
              min="<%= new Date().toISOString().slice(0,10) %>"
              class="w-full border rounded-xl px-4 py-3"
            />
          </div>
        </div>

        <!-- SCHEDULE -->
        <div>
          <label class="block text-sm font-semibold mb-2">Schedule</label>

          <div id="schedule-container" class="space-y-3">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <select name="schedule[0][day]" class="border rounded-xl px-4 py-3">
                <option>Mon</option><option>Tue</option><option>Wed</option>
                <option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
              </select>
              <input type="time" name="schedule[0][startTime]"
                class="border rounded-xl px-4 py-3"/>
              <div class="flex items-center gap-2">
                <input type="time" name="schedule[0][endTime]"
                  class="border rounded-xl px-4 py-3 flex-1"/>
                <button
                  type="button"
                  class="text-red-500 text-xs font-semibold remove-schedule"
                  title="Remove this schedule row"
                >
                  Remove
                </button>
              </div>
            </div>
          </div>

          <button type="button" id="add-schedule"
            class="mt-3 text-blue-600 font-semibold text-sm">
            + Add another schedule
          </button>
        </div>

        <!-- SUBMIT -->
        <button type="submit"
          class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold
                 hover:bg-blue-700 transition">
          Create Class
        </button>

      </form>
    </div>
  </div>
</main>

<script>
  document.getElementById("menuBtn")?.addEventListener("click", () => {
    document.querySelector(".sidebar")?.classList.toggle("hidden");
  });

  document.getElementById("add-schedule").addEventListener("click", () => {
    const container = document.getElementById("schedule-container");
    const index = container.children.length;

    container.insertAdjacentHTML("beforeend", `
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <select name="schedule[${index}][day]" class="border rounded-xl px-4 py-3">
          <option>Mon</option><option>Tue</option><option>Wed</option>
          <option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
        </select>
        <input type="time" name="schedule[${index}][startTime]" class="border rounded-xl px-4 py-3"/>
        <div class="flex items-center gap-2">
          <input type="time" name="schedule[${index}][endTime]" class="border rounded-xl px-4 py-3 flex-1"/>
          <button
            type="button"
            class="text-red-500 text-xs font-semibold remove-schedule"
            title="Remove this schedule row"
          >
            Remove
          </button>
        </div>
      </div>
    `);

    // Re-apply allowed days and time limits when a new row is added
    filterScheduleDaysByDateRange();
    applyTodayTimeMin();
  });

  // Helper: compute allowed weekdays between startDate and endDate
  function getAllowedWeekdays() {
    const startInput = document.querySelector('input[name="startDate"]');
    const endInput = document.querySelector('input[name="endDate"]');

    if (!startInput || !endInput || !startInput.value || !endInput.value) {
      return null; // no restriction yet
    }

    const start = new Date(startInput.value);
    const end = new Date(endInput.value);
    if (isNaN(start) || isNaN(end) || end < start) {
      return null;
    }

    const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    const allowed = new Set();

    const cursor = new Date(start);
    while (cursor <= end) {
      allowed.add(dayNames[cursor.getDay()]);
      cursor.setDate(cursor.getDate() + 1);
    }

    return allowed;
  }

  // Apply allowed days to all schedule day selects
  function filterScheduleDaysByDateRange() {
    const allowed = getAllowedWeekdays();
    const selects = document.querySelectorAll(
      '#schedule-container select[name^="schedule"][name$="[day]"]'
    );

    selects.forEach((sel) => {
      const options = sel.options;
      for (let i = 0; i < options.length; i++) {
        const opt = options[i];
        if (!allowed) {
          // No restriction: enable all
          opt.disabled = false;
        } else {
          opt.disabled = !allowed.has(opt.textContent.trim());
        }
      }

      // If current value is now disabled, reset to first enabled option
      if (sel.selectedOptions.length && sel.selectedOptions[0].disabled) {
        for (let i = 0; i < options.length; i++) {
          if (!options[i].disabled) {
            sel.value = options[i].textContent.trim();
            break;
          }
        }
      }
    });
  }

  // When start/end date is today and same day, only allow remaining time today
  function applyTodayTimeMin() {
    const startInput = document.querySelector('input[name="startDate"]');
    const endInput = document.querySelector('input[name="endDate"]');
    if (!startInput || !endInput) return;

    const startVal = startInput.value;
    const endVal = endInput.value;
    const todayStr = new Date().toISOString().slice(0, 10);

    const isTodaySingleDay =
      startVal && endVal && startVal === endVal && startVal === todayStr;

    const timeInputs = document.querySelectorAll(
      '#schedule-container input[type="time"]'
    );

    if (isTodaySingleDay) {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      const minTime = `${hh}:${mm}`;

      timeInputs.forEach((input) => {
        input.min = minTime;
        if (input.value && input.value < minTime) {
          input.value = minTime;
        }
      });
    } else {
      // Clear min when not restricted to today-only
      timeInputs.forEach((input) => {
        input.min = "";
      });
    }
  }

  // Set initial schedule day to current weekday
  (function () {
    const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    const todayName = dayNames[new Date().getDay()];
    const firstDaySelect = document.querySelector(
      '#schedule-container select[name^="schedule"][name$="[day]"]'
    );
    if (firstDaySelect) {
      firstDaySelect.value = todayName;
    }
  })();

  // Refilter days whenever date range changes and update time limits for today
  document.querySelector('input[name="startDate"]').addEventListener(
    "change",
    () => {
      filterScheduleDaysByDateRange();
      applyTodayTimeMin();
    }
  );
  document.querySelector('input[name="endDate"]').addEventListener(
    "change",
    () => {
      filterScheduleDaysByDateRange();
      applyTodayTimeMin();
    }
  );

  // Initial filter (in case dates already filled by browser)
  filterScheduleDaysByDateRange();
  applyTodayTimeMin();

  // ================= REMOVE SCHEDULE ROWS (MARK AS DISABLED) =================
  document.getElementById("schedule-container")?.addEventListener("click", (e) => {
    if (e.target.classList.contains("remove-schedule")) {
      const row = e.target.closest(
        "#schedule-container .grid.grid-cols-1.sm\\:grid-cols-3"
      );
      if (!row) return;

      // Physically remove the row so its fields are not submitted at all
      row.remove();
    }
  });

  // ================= VALIDATE SCHEDULE ROWS ON SUBMIT =================
  const classForm = document.querySelector('form[action="/admin/classes/create"]');
  if (classForm) {
    classForm.addEventListener("submit", (e) => {
      const rows = document.querySelectorAll(
        "#schedule-container .grid.grid-cols-1.sm\\:grid-cols-3"
      );

      let validCount = 0;
      let error = null;

      rows.forEach((row) => {
        const startInput = row.querySelector('input[name*="[startTime]"]');
        const endInput = row.querySelector('input[name*="[endTime]"]');
        if (!startInput || !endInput) return;

        const startVal = (startInput.value || "").trim();
        const endVal = (endInput.value || "").trim();

        if (!startVal && !endVal) {
          // Row exists but has no times -> block submit
          error =
            "Each schedule row must have both start and end time filled. Remove empty rows or complete them.";
        } else if (!startVal || !endVal) {
          error =
            "Each schedule row must have both start and end time filled.";
        } else {
          validCount += 1;
        }
      });

      if (!error && validCount === 0) {
        error = "Please add at least one schedule with start and end time.";
      }

      if (error) {
        e.preventDefault();
        alert(error);
      }
    });
  }
</script>

<%- include('../layouts/footer') %>

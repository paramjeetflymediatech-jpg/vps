<%- include('../layouts/header') %>
<%- include('../layouts/sidebar') %>
<main class="flex-1 md:ml-64 p-4 md:p-6 bg-gray-100 min-h-screen">
  <!-- MOBILE HEADER -->
  <div class="flex items-center justify-between mb-6 md:hidden">
    <button class="menu-btn bg-blue-600 text-white px-3 py-2 rounded">â˜°</button>
    <h1 class="text-xl font-semibold">Edit Course</h1>
  </div>

  <!-- DESKTOP HEADER -->
  <div class="hidden md:flex justify-between items-center mb-6">
    <h1 class="text-2xl font-semibold"></h1>
  </div>
<div class="mx-auto p-3 bg-white  rounded-xl shadow">
  <h1 class="text-2xl font-semibold mb-6">Edit Course</h1>

  <% if (error) { %>
    <div class="bg-red-100 text-red-700 p-3 rounded mb-4">
      <%= error %>
    </div>
  <% } %>

  <form
    action="/admin/courses/edit/<%= course._id %>"
    method="POST"
    enctype="multipart/form-data"
    class="space-y-5"
  >
    <!-- Course Title -->
    <div>
      <label class="block text-sm font-medium mb-1">Course Title</label>
      <input
        type="text"
        name="title"
        value="<%= course.title %>"
        required
        class="w-full border rounded px-4 py-2"
      />
    </div>

    <!-- Description -->
    <div>
      <label class="block text-sm font-medium mb-1">Description</label>
      <textarea
        name="description"
        rows="4"
        required
        class="w-full border rounded px-4 py-2"
      ><%= course.description %></textarea>
    </div>

    <!-- Assign Tutor -->
    <div>
      <label class="block text-sm font-medium mb-1">Assign Tutor</label>
      <select
        name="tutorId"
        required
        class="w-full border rounded px-4 py-2"
      >
        <option value="">-- Select Tutor --</option>
        <% tutors.forEach(tutor => { %>
          <option
            value="<%= tutor._id %>"
            <%= course.tutorId && course.tutorId.toString() === tutor._id.toString() ? "selected" : "" %>
          >
            <%= tutor.name %> (<%= tutor.email %>)
          </option>
        <% }) %>
      </select>
    </div>

    <!-- Price -->
    <div>
      <label class="block text-sm font-medium mb-1">Price</label>
      <input
        type="number"
        name="price"
        value="<%= course.price %>"
        min="0"
        class="w-full border rounded px-4 py-2"
      />
    </div>

    <!-- LINK CLASSES (OPTIONAL) -->
    <div>
      <label class="block text-sm font-medium mb-1">Attach Classes (optional)</label>
      <p class="text-xs text-gray-500 mb-1">
        Hold Ctrl (Windows) or Cmd (Mac) to select multiple classes.
      </p>
      <div class="flex items-center gap-3 mb-2">
        <select
          id="classes-select"
          name="classes"
          multiple
          class="flex-1 w-full border rounded px-4 py-2 min-h-[120px]"
        >
          <% const selectedClassIds = (course.classes || []).map(c => c.toString ? c.toString() : c); %>
          <% if (typeof classes !== 'undefined') { %>
            <% classes.forEach(cls => { %>
              <option
                value="<%= cls._id %>"
                <%= selectedClassIds.includes(cls._id.toString()) ? 'selected' : '' %>
              >
                <%= cls.title %>
                <% if (cls.startDate && cls.endDate) { %>
                  (
                  <%= new Date(cls.startDate).toLocaleDateString() %>
                  -
                  <%= new Date(cls.endDate).toLocaleDateString() %>
                  )
                <% } %>
              </option>
            <% }) %>
          <% } %>
        </select>

        <% if (selectedClassIds && selectedClassIds.length) { %>
          <button
            type="button"
            id="reload-classes-btn"
            class="px-3 py-2 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
          >
            Load latest upcoming classes
          </button>
        <% } %>
      </div>
      <p class="text-[11px] text-gray-500">
        Button will refresh this list with upcoming classes (by start date). Existing selected classes stay selected.
      </p>
    </div>

    <!-- Current Image -->
    <% if (course.image) { %>
      <div>
        <label class="block text-sm font-medium mb-2">Current Image</label>
        <img
          src="<%= course.image %>"
          class="w-40 rounded border"
        />
      </div>
    <% } %>

    <!-- Replace Image -->
    <div>
      <label class="block text-sm font-medium mb-1">Replace Image</label>
      <input type="file" name="image" accept="image/*" />
      <p class="text-sm text-gray-500">Leave empty to keep existing image</p>
    </div>

    <!-- Publish -->
    <div class="flex items-center gap-2">
      <input
        type="checkbox"
        name="published"
        id="published"
        <%= course.published ? "checked" : "" %>
      />
      <label for="published">Published</label>
    </div>

    <!-- Actions -->
    <div class="flex gap-3">
      <button
        type="submit"
        class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700"
      >
        Update Course
      </button>

      <a
        href="/admin/courses"
        class="bg-gray-200 px-6 py-2 rounded"
      >
        Cancel
      </a>
    </div>
  </form>
</div>

</main>

<script>
  (function () {
    const reloadBtn = document.getElementById("reload-classes-btn");
    const selectEl = document.getElementById("classes-select");

    if (!reloadBtn || !selectEl) return;

    reloadBtn.addEventListener("click", async () => {\r
      reloadBtn.disabled = true;
      reloadBtn.textContent = "Loading...";
      try {
        const res = await fetch("/admin/classes/upcoming", {
          headers: { "Accept": "application/json" },
          credentials: "same-origin",
        });
        if (!res.ok) throw new Error("Failed to load classes");
        const json = await res.json();
        if (!json.success || !Array.isArray(json.data)) {
          throw new Error("Unexpected response");
        }

        const latest = json.data;

        // Preserve current selections
        const selectedValues = new Set(
          Array.from(selectEl.options)
            .filter((o) => o.selected)
            .map((o) => o.value)
        );

        // Build a map of existing options by value to avoid duplicates
        const existingOptions = new Map();
        Array.from(selectEl.options).forEach((o) => {
          existingOptions.set(o.value, o);
        });

        // Append/merge latest upcoming classes
        latest.forEach((cls) => {
          const id = String(cls._id);
          const start = cls.startDate ? new Date(cls.startDate) : null;
          const end = cls.endDate ? new Date(cls.endDate) : null;
          const labelParts = [cls.title];
          if (start && end) {
            labelParts.push(
              " (" +
              start.toLocaleDateString() +
              " - " +
              end.toLocaleDateString() +
              ")"
            );
          }
          const text = labelParts.join("");

          let opt = existingOptions.get(id);
          if (!opt) {
            opt = document.createElement("option");
            opt.value = id;
            existingOptions.set(id, opt);
            selectEl.appendChild(opt);
          }
          opt.textContent = text;
        });

        // Restore selections
        Array.from(selectEl.options).forEach((o) => {
          o.selected = selectedValues.has(o.value);
        });
      } catch (err) {
        console.error(err);
        alert("Failed to load latest classes. Please try again.");
      } finally {
        reloadBtn.disabled = false;
        reloadBtn.textContent = "Load latest upcoming classes";
      }
    });
  })();
</script>

<%- include('../layouts/footer') %>
